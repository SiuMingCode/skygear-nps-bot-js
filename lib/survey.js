'use strict';

const moment = require('moment');
const skygear = require('skygear');
const { DEVELOPMENT_MODE } = require('./config');
const db = require('./db');
const Reply = require('./reply');

class Survey {
  constructor(record) {
    this._record = record;
  }

  // create
  static get Record() {
    return skygear.Record.extend('survey');
  }

  static create(teamID, frequency, targetsID, scheduledDatetime) {
    let record = new Survey.Record({
      teamID,
      frequency,
      targetsID,
      scheduledDatetime,
      isSent: false,
      isClosed: false
    });
    return db.save(record).then(record => new Survey(record));
  }

  // read
  get id() {
    return this._record['id'];
  }

  get teamID() {
    return this._record['teamID'];
  }

  get frequency() {
    return this._record['frequency'];
  }

  get targetsID() {
    return this._record['targetsID'];
  }

  get scheduledDatetime() {
    return this._record['scheduledDatetime'];
  }

  get isSent() {
    return this._record['isSent'];
  }

  get isClosed() {
    return this._record['isClosed'];
  }

  static of(_id) {
    let query = new skygear.Query(Survey.Record);
    query.equalTo('_id', _id);
    return db.query(query).then(result => result[0] ? new Survey(result[0]) : null);
  }

  static get candidatesOfDistribution() {
    let query = new skygear.Query(Survey.Record);
    query.equalTo('isSent', false);
    // survey.scheduledDatetime == now, time to send
    // survey.scheduledDatetime < now, delayed
    // now < survey.scheduledDatetime, not yet
    // we want delayed or time to send
    // survey.scheduleDate <= now
    // 'scheduleDate' is at lhs
    query.lessThanOrEqualTo('scheduledDatetime', new Date());
    return db.query(query).then(result => {
      let records = [];
      for (let i = 0; i < result.length; i++) {
        records.push(new Survey(result[i]));
      }
      return records;
    });
  }

  static get candidatesOfClosing() {
    let query = new skygear.Query(Survey.Record);
    query.equalTo('isSent', true);
    query.equalTo('isClosed', false);
    // survey.endTime == now, time to close
    // survey.endTime < now, delayed
    // now < survey.endTime, not yet
    // 'scheduleDate' is at lhs
    // we want delayed or time to close
    // survey.endTime <= now
    // survey.scheduledDatetime + 48 hours <= now
    // survey.scheduledDatetime <= now - 48 hours
    // 'scheduleDate' is at lhs
    if (DEVELOPMENT_MODE) {
      query.lessThanOrEqualTo('scheduledDatetime', moment().subtract(30, 's').toDate());
    } else {
      query.lessThanOrEqualTo('scheduledDatetime', moment().subtract(48, 'h').toDate());
    }
    return db.query(query).then(result => {
      let records = [];
      for (let i = 0; i < result.length; i++) {
        records.push(new Survey(result[i]));
      }
      return records;
    });
  }

  static get distributed() {
    let query = new skygear.Query(Survey.Record);
    query.equalTo('isSent', true);
    query.equalTo('isClosed', false);
    return db.query(query).then(result => {
      let records = [];
      for (let i = 0; i < result.length; i++) {
        records.push(new Survey(result[i]));
      }
      return records;
    });
  }

  // update

  set isSent(newValue) {
    this._record['isSent'] = newValue;
  }

  set isClosed(newValue) {
    this._record['isClosed'] = newValue;
  }

  update() {
    return db.save(this._record).then(record => new Survey(record));
  }

  // delete

  delete() {
    return db.delete(this._record);
  }

  // misc
  get replies() {
    return Reply.of(this.id);
  }
}

module.exports = Survey;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zdXJ2ZXkuanMiXSwibmFtZXMiOlsibW9tZW50IiwicmVxdWlyZSIsInNreWdlYXIiLCJERVZFTE9QTUVOVF9NT0RFIiwiZGIiLCJSZXBseSIsIlN1cnZleSIsImNvbnN0cnVjdG9yIiwicmVjb3JkIiwiX3JlY29yZCIsIlJlY29yZCIsImV4dGVuZCIsImNyZWF0ZSIsInRlYW1JRCIsImZyZXF1ZW5jeSIsInRhcmdldHNJRCIsInNjaGVkdWxlZERhdGV0aW1lIiwiaXNTZW50IiwiaXNDbG9zZWQiLCJzYXZlIiwidGhlbiIsImlkIiwib2YiLCJfaWQiLCJxdWVyeSIsIlF1ZXJ5IiwiZXF1YWxUbyIsInJlc3VsdCIsImNhbmRpZGF0ZXNPZkRpc3RyaWJ1dGlvbiIsImxlc3NUaGFuT3JFcXVhbFRvIiwiRGF0ZSIsInJlY29yZHMiLCJpIiwibGVuZ3RoIiwicHVzaCIsImNhbmRpZGF0ZXNPZkNsb3NpbmciLCJzdWJ0cmFjdCIsInRvRGF0ZSIsImRpc3RyaWJ1dGVkIiwibmV3VmFsdWUiLCJ1cGRhdGUiLCJkZWxldGUiLCJyZXBsaWVzIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNQSxTQUFTQyxRQUFRLFFBQVIsQ0FBZjtBQUNBLE1BQU1DLFVBQVVELFFBQVEsU0FBUixDQUFoQjtBQUNBLE1BQU0sRUFBRUUsZ0JBQUYsS0FBdUJGLFFBQVEsVUFBUixDQUE3QjtBQUNBLE1BQU1HLEtBQUtILFFBQVEsTUFBUixDQUFYO0FBQ0EsTUFBTUksUUFBUUosUUFBUSxTQUFSLENBQWQ7O0FBRUEsTUFBTUssTUFBTixDQUFhO0FBQ1hDLGNBQWFDLE1BQWIsRUFBcUI7QUFDbkIsU0FBS0MsT0FBTCxHQUFlRCxNQUFmO0FBQ0Q7O0FBRUQ7QUFDQSxhQUFXRSxNQUFYLEdBQXFCO0FBQ25CLFdBQU9SLFFBQVFRLE1BQVIsQ0FBZUMsTUFBZixDQUFzQixRQUF0QixDQUFQO0FBQ0Q7O0FBRUQsU0FBT0MsTUFBUCxDQUFlQyxNQUFmLEVB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LFFBQWQsRUFBd0I7QUFDdEIsU0FBSzlCLE9BQUwsQ0FBYSxVQUFiLElBQTJCOEIsUUFBM0I7QUFDRDs7QUFFREMsV0FBVTtBQUNSLFdBQU9wQyxHQUFHZSxJQUFILENBQVEsS0FBS1YsT0FBYixFQUFzQlcsSUFBdEIsQ0FBMkJaLFVBQVUsSUFBSUYsTUFBSixDQUFXRSxNQUFYLENBQXJDLENBQVA7QUFDRDs7QUFFRDs7QUFFQWlDLFdBQVU7QUFDUixXQUFPckMsR0FBR3FDLE1BQUgsQ0FBVSxLQUFLaEMsT0FBZixDQUFQO0FBQ0Q7O0FBRUQ7QUFDQSxNQUFJaUMsT0FBSixHQUFlO0FBQ2IsV0FBT3JDLE1BQU1pQixFQUFOLENBQVMsS0FBS0QsRUFBZCxDQUFQO0FBQ0Q7QUEzSVU7O0FBOElic0IsT0FBT0MsT0FBUCxHQUFpQnRDLE1BQWpCIiwiZmlsZSI6InN1cnZleS5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IG1vbWVudCA9IHJlcXVpcmUoJ21vbWVudCcpXG5jb25zdCBza3lnZWFyID0gcmVxdWlyZSgnc2t5Z2VhcicpXG5jb25zdCB7IERFVkVMT1BNRU5UX01PREUgfSA9IHJlcXVpcmUoJy4vY29uZmlnJylcbmNvbnN0IGRiID0gcmVxdWlyZSgnLi9kYicpXG5jb25zdCBSZXBseSA9IHJlcXVpcmUoJy4vcmVwbHknKVxuXG5jbGFzcyBTdXJ2ZXkge1xuICBjb25zdHJ1Y3RvciAocmVjb3JkKSB7XG4gICAgdGhpcy5fcmVjb3JkID0gcmVjb3JkXG4gIH1cblxuICAvLyBjcmVhdGVcbiAgc3RhdGljIGdldCBSZWNvcmQgKCkge1xuICAgIHJldHVybiBza3lnZWFyLlJlY29yZC5leHRlbmQoJ3N1cnZleScpXG4gIH1cblxuICBzdGF0aWMgY3JlYXRlICh0ZWFtSUQsIGZyZXF1ZW5jeSwgdGFyZ2V0c0lELCBzY2hlZHVsZWREYXRldGltZSkge1xuICAgIGxldCByZWNvcmQgPSBuZXcgU3VydmV5LlJlY29yZCh7XG4gICAgICB0ZWFtSUQsXG4gICAgICBmcmVxdWVuY3ksXG4gICAgICB0YXJnZXRzSUQsXG4gICAgICBzY2hlZHVsZWREYXRldGltZSxcbiAgICAgIGlzU2VudDogZmFsc2UsXG4gICAgICBpc0Nsb3NlZDogZmFsc2VcbiAgICB9KVxuICAgIHJldHVybiBkYi5zYXZlKHJlY29yZCkudGhlbihyZWNvcmQgPT4gbmV3IFN1cnZleShyZWNvcmQpKVxuICB9XG5cbiAgLy8gcmVhZFxuICBnZXQgaWQgKCkge1xuICAgIHJldHVybiB0aGlzLl9yZWNvcmRbJ2lkJ11cbiAgfVxuXG4gIGdldCB0ZWFtSUQgKCkge1xuICAgIHJldHVybiB0aGlzLl9yZWNvcmRbJ3RlYW1JRCddXG4gIH1cblxuICBnZXQgZnJlcXVlbmN5ICgpIHtcbiAgICByZXR1cm4gdGhpcy5fcmVjb3JkWydmcmVxdWVuY3knXVxuICB9XG5cbiAgZ2V0IHRhcmdldHNJRCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsndGFyZ2V0c0lEJ11cbiAgfVxuXG4gIGdldCBzY2hlZHVsZWREYXRldGltZSAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsnc2NoZWR1bGVkRGF0ZXRpbWUnXVxuICB9XG5cbiAgZ2V0IGlzU2VudCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsnaXNTZW50J11cbiAgfVxuXG4gIGdldCBpc0Nsb3NlZCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsnaXNDbG9zZWQnXVxuICB9XG5cbiAgc3RhdGljIG9mIChfaWQpIHtcbiAgICBsZXQgcXVlcnkgPSBuZXcgc2t5Z2Vhci5RdWVyeShTdXJ2ZXkuUmVjb3JkKVxuICAgIHF1ZXJ5LmVxdWFsVG8oJ19pZCcsIF9pZClcbiAgICByZXR1cm4gZGIucXVlcnkocXVlcnkpLnRoZW4ocmVzdWx0ID0+IHJlc3VsdFswXSA/IG5ldyBTdXJ2ZXkocmVzdWx0WzBdKSA6IG51bGwpXG4gIH1cblxuICBzdGF0aWMgZ2V0IGNhbmRpZGF0ZXNPZkRpc3RyaWJ1dGlvbiAoKSB7XG4gICAgbGV0IHF1ZXJ5ID0gbmV3IHNreWdlYXIuUXVlcnkoU3VydmV5LlJlY29yZClcbiAgICBxdWVyeS5lcXVhbFRvKCdpc1NlbnQnLCBmYWxzZSlcbiAgICAvLyBzdXJ2ZXkuc2NoZWR1bGVkRGF0ZXRpbWUgPT0gbm93LCB0aW1lIHRvIHNlbmRcbiAgICAvLyBzdXJ2ZXkuc2NoZWR1bGVkRGF0ZXRpbWUgPCBub3csIGRlbGF5ZWRcbiAgICAvLyBub3cgPCBzdXJ2ZXkuc2NoZWR1bGVkRGF0ZXRpbWUsIG5vdCB5ZXRcbiAgICAvLyB3ZSB3YW50IGRlbGF5ZWQgb3IgdGltZSB0byBzZW5kXG4gICAgLy8gc3VydmV5LnNjaGVkdWxlRGF0ZSA8PSBub3dcbiAgICAvLyAnc2NoZWR1bGVEYXRlJyBpcyBhdCBsaHNcbiAgICBxdWVyeS5sZXNzVGhhbk9yRXF1YWxUbygnc2NoZWR1bGVkRGF0ZXRpbWUnLCBuZXcgRGF0ZSgpKVxuICAgIHJldHVybiBkYi5xdWVyeShxdWVyeSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgbGV0IHJlY29yZHMgPSBbXVxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXN1bHQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgcmVjb3Jkcy5wdXNoKG5ldyBTdXJ2ZXkocmVzdWx0W2ldKSlcbiAgICAgIH1cbiAgICAgIHJldHVybiByZWNvcmRzXG4gICAgfSlcbiAgfVxuXG4gIHN0YXRpYyBnZXQgY2FuZGlkYXRlc09mQ2xvc2luZyAoKSB7XG4gICAgbGV0IHF1ZXJ5ID0gbmV3IHNreWdlYXIuUXVlcnkoU3VydmV5LlJlY29yZClcbiAgICBxdWVyeS5lcXVhbFRvKCdpc1NlbnQnLCB0cnVlKVxuICAgIHF1ZXJ5LmVxdWFsVG8oJ2lzQ2xvc2VkJywgZmFsc2UpXG4gICAgLy8gc3VydmV5LmVuZFRpbWUgPT0gbm93LCB0aW1lIHRvIGNsb3NlXG4gICAgLy8gc3VydmV5LmVuZFRpbWUgPCBub3csIGRlbGF5ZWRcbiAgICAvLyBub3cgPCBzdXJ2ZXkuZW5kVGltZSwgbm90IHlldFxuICAgIC8vICdzY2hlZHVsZURhdGUnIGlzIGF0IGxoc1xuICAgIC8vIHdlIHdhbnQgZGVsYXllZCBvciB0aW1lIHRvIGNsb3NlXG4gICAgLy8gc3VydmV5LmVuZFRpbWUgPD0gbm93XG4gICAgLy8gc3VydmV5LnNjaGVkdWxlZERhdGV0aW1lICsgNDggaG91cnMgPD0gbm93XG4gICAgLy8gc3VydmV5LnNjaGVkdWxlZERhdGV0aW1lIDw9IG5vdyAtIDQ4IGhvdXJzXG4gICAgLy8gJ3NjaGVkdWxlRGF0ZScgaXMgYXQgbGhzXG4gICAgaWYgKERFVkVMT1BNRU5UX01PREUpIHtcbiAgICAgIHF1ZXJ5Lmxlc3NUaGFuT3JFcXVhbFRvKCdzY2hlZHVsZWREYXRldGltZScsIG1vbWVudCgpLnN1YnRyYWN0KDMwLCAncycpLnRvRGF0ZSgpKVxuICAgIH0gZWxzZSB7XG4gICAgICBxdWVyeS5sZXNzVGhhbk9yRXF1YWxUbygnc2NoZWR1bGVkRGF0ZXRpbWUnLCBtb21lbnQoKS5zdWJ0cmFjdCg0OCwgJ2gnKS50b0RhdGUoKSlcbiAgICB9XG4gICAgcmV0dXJuIGRiLnF1ZXJ5KHF1ZXJ5KS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICBsZXQgcmVjb3JkcyA9IFtdXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc3VsdC5sZW5ndGg7IGkrKykge1xuICAgICAgICByZWNvcmRzLnB1c2gobmV3IFN1cnZleShyZXN1bHRbaV0pKVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlY29yZHNcbiAgICB9KVxuICB9XG5cbiAgc3RhdGljIGdldCBkaXN0cmlidXRlZCAoKSB7XG4gICAgbGV0IHF1ZXJ5ID0gbmV3IHNreWdlYXIuUXVlcnkoU3VydmV5LlJlY29yZClcbiAgICBxdWVyeS5lcXVhbFRvKCdpc1NlbnQnLCB0cnVlKVxuICAgIHF1ZXJ5LmVxdWFsVG8oJ2lzQ2xvc2VkJywgZmFsc2UpXG4gICAgcmV0dXJuIGRiLnF1ZXJ5KHF1ZXJ5KS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICBsZXQgcmVjb3JkcyA9IFtdXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc3VsdC5sZW5ndGg7IGkrKykge1xuICAgICAgICByZWNvcmRzLnB1c2gobmV3IFN1cnZleShyZXN1bHRbaV0pKVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlY29yZHNcbiAgICB9KVxuICB9XG5cbiAgLy8gdXBkYXRlXG5cbiAgc2V0IGlzU2VudCAobmV3VmFsdWUpIHtcbiAgICB0aGlzLl9yZWNvcmRbJ2lzU2VudCddID0gbmV3VmFsdWVcbiAgfVxuXG4gIHNldCBpc0Nsb3NlZCAobmV3VmFsdWUpIHtcbiAgICB0aGlzLl9yZWNvcmRbJ2lzQ2xvc2VkJ10gPSBuZXdWYWx1ZVxuICB9XG5cbiAgdXBkYXRlICgpIHtcbiAgICByZXR1cm4gZGIuc2F2ZSh0aGlzLl9yZWNvcmQpLnRoZW4ocmVjb3JkID0+IG5ldyBTdXJ2ZXkocmVjb3JkKSlcbiAgfVxuXG4gIC8vIGRlbGV0ZVxuXG4gIGRlbGV0ZSAoKSB7XG4gICAgcmV0dXJuIGRiLmRlbGV0ZSh0aGlzLl9yZWNvcmQpXG4gIH1cblxuICAvLyBtaXNjXG4gIGdldCByZXBsaWVzICgpIHtcbiAgICByZXR1cm4gUmVwbHkub2YodGhpcy5pZClcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFN1cnZleVxuIl19