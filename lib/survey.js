'use strict';

const moment = require('moment');
const skygear = require('skygear');
const { DEVELOPMENT_MODE } = require('./config');
const db = require('./db');
const Reply = require('./reply');

class Survey {
  constructor(record) {
    this._record = record;
  }

  static get Record() {
    return skygear.Record.extend('survey');
  }

  static create(teamID, frequency, excludedUsersID, scheduledDatetime) {
    let isSent = false;
    let isClosed = false;
    let record = new Survey.Record({
      teamID,
      frequency,
      excludedUsersID,
      scheduledDatetime,
      isSent,
      isClosed
    });
    return db.save(record).then(record => new Survey(record));
  }

  get id() {
    return this._record['id'];
  }

  get teamID() {
    return this._record['teamID'];
  }

  get frequency() {
    return this._record['frequency'];
  }

  get excludedUsersID() {
    return this._record['excludedUsersID'];
  }

  get scheduledDatetime() {
    return this._record['scheduledDatetime'];
  }

  get isSent() {
    return this._record['isSent'];
  }

  get isClosed() {
    return this._record['isClosed'];
  }

  static of(id) {
    let query = new skygear.Query(Survey.Record);
    query.equalTo('_id', id);
    return db.query(query).then(result => result[0] ? new Survey(result[0]) : null);
  }

  static scheduledBy(teamID) {
    let query = new skygear.Query(Survey.Record);
    query.equalTo('teamID', teamID);
    query.equalTo('isSent', false);
    return db.query(query).then(result => {
      if (result.length > 1) {
        throw new Error(`Mutiple scheduled surveys found for team ${teamID}`);
      }
      return result[0] ? new Survey(result[0]) : null;
    });
  }

  static openingIn(teamID) {
    let query = new skygear.Query(Survey.Record);
    query.equalTo('teamID', teamID);
    query.equalTo('isSent', true);
    query.equalTo('isClosed', false);
    return db.query(query).then(result => {
      if (result.length > 1) {
        throw new Error(`Mutiple opening surveys found for team ${teamID}`);
      }
      return result[0] ? new Survey(result[0]) : null;
    });
  }

  static get timeToSend() {
    let query = new skygear.Query(Survey.Record);
    query.equalTo('isSent', false);
    query.lessThanOrEqualTo('scheduledDatetime', new Date());
    return db.query(query).then(result => {
      let records = [];
      for (let i = 0; i < result.length; i++) {
        records.push(new Survey(result[i]));
      }
      return records;
    });
  }

  static get timeToClose() {
    let query = new skygear.Query(Survey.Record);
    query.equalTo('isSent', true);
    query.equalTo('isClosed', false);
    let unit = DEVELOPMENT_MODE ? 'seconds' : 'hours';
    query.greaterThanOrEqualTo('scheduledDatetime', moment().subtract(48, unit).toDate());
    return db.query(query).then(result => {
      let records = [];
      for (let i = 0; i < result.length; i++) {
        records.push(new Survey(result[i]));
      }
      return records;
    });
  }

  set isSent(newValue) {
    this._record['isSent'] = newValue;
  }

  set isClosed(newValue) {
    this._record['isClosed'] = newValue;
  }

  update() {
    return db.save(this._record).then(record => new Survey(record));
  }

  get replies() {
    return Reply.of(this.id);
  }

  get q1() {
    return {
      text: 'How likely is it you would recommend this company as a place to work?',
      attachments: [{
        text: 'Choose a score from 10 (hightest) to 1 (lowest)',
        fallback: 'You are unable to select a score',
        callback_id: 'saveScoreAndRequestReason',
        actions: [{
          name: 'scores',
          type: 'select',
          options: [{
            text: '10',
            value: JSON.stringify({
              score: 10,
              surveyID: this.id
            })
          }, {
            text: '9',
            value: JSON.stringify({
              score: 9,
              surveyID: this.id
            })
          }, {
            text: '8',
            value: JSON.stringify({
              score: 8,
              surveyID: this.id
            })
          }, {
            text: '7',
            value: JSON.stringify({
              score: 7,
              surveyID: this.id
            })
          }, {
            text: '6',
            value: JSON.stringify({
              score: 6,
              surveyID: this.id
            })
          }, {
            text: '5',
            value: JSON.stringify({
              score: 5,
              surveyID: this.id
            })
          }, {
            text: '4',
            value: JSON.stringify({
              score: 4,
              surveyID: this.id
            })
          }, {
            text: '3',
            value: JSON.stringify({
              score: 3,
              surveyID: this.id
            })
          }, {
            text: '2',
            value: JSON.stringify({
              score: 2,
              surveyID: this.id
            })
          }, {
            text: '1',
            value: JSON.stringify({
              score: 1,
              surveyID: this.id
            })
          }]
        }]
      }]
    };
  }
}

module.exports = Survey;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zdXJ2ZXkuanMiXSwibmFtZXMiOlsibW9tZW50IiwicmVxdWlyZSIsInNreWdlYXIiLCJERVZFTE9QTUVOVF9NT0RFIiwiZGIiLCJSZXBseSIsIlN1cnZleSIsImNvbnN0cnVjdG9yIiwicmVjb3JkIiwiX3JlY29yZCIsIlJlY29yZCIsImV4dGVuZCIsImNyZWF0ZSIsInRlYW1JRCIsImZyZXF1ZW5jeSIsImV4Y2x1ZGVkVXNlcnNJRCIsInNjaGVkdWxlZERhdGV0aW1lIiwiaXNTZW50IiwiaXNDbG9zZWQiLCJzYXZlIiwidGhlbiIsImlkIiwib2YiLCJxdWVyeSIsIlF1ZXJ5IiwiZXF1YWxUbyIsInJlc3VsdCIsInNjaGVkdWxlZEJ5IiwibGVuZ3RoIiwiRXJyb3IiLCJvcGVuaW5nSW4iLCJ0aW1lVG9TZW5kIiwibGVzc1RoYW5PckVxdWFsVG8iLCJEYXRlIiwicmVjb3JkcyIsImkiLCJwdXNoIiwidGltZVRvQ2xvc2UiLCJ1bml0IiwiZ3JlYXRlclRoYW5PckVxdWFsVG8iLCJzdWJ0cmFjdCIsInRvRGF0ZSIsIm5ld1ZhbHVlIiwidXBkYXRlIiwicmVwbGllcyIsInExIiwidGV4dCIsImF0dGFjaG1lbnRzIiwiZmFsbGJhY2siLCJjYWxsYmFja19pZCIsImFjdGlvbnMiLCJuYW1lIiwidHlwZSIsIm9wdGlvbnMiLCJ2YWx1ZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJzY29yZSIsInN1cnZleUlEIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNQSxTQUFTQyxRQUFRLFFBQVIsQ0FBZjtBQUNBLE1BQU1DLFVBQVVELFFBQVEsU0FBUixDQUFoQjtBQUNBLE1BQU0sRUFBRUUsZ0JBQUYsS0FBdUJGLFFBQVEsVUFBUixDQUE3QjtBQUNBLE1BQU1HLEtBQUtILFFBQVEsTUFBUixDQUFYO0FBQ0EsTUFBTUksUUFBUUosUUFBUSxTQUFSLENBQWQ7O0FBRUEsTUFBTUssTUFBTixDQUFhO0FBQ1hDLGNBQWFDLE1BQWIsRUFB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eURQO0FBQ0V5QixrQkFBTSxHQURSO0FBRUVRLG1CQUFPQyxLQUFLQyxTQUFMLENBQWU7QUFDcEJDLHFCQUFPLENBRGE7QUFFcEJDLHdCQUFVLEtBQUtyQztBQUZLLGFBQWY7QUFGVCxXQXpETyxFQWdFUDtBQUNFeUIsa0JBQU0sR0FEUjtBQUVFUSxtQkFBT0MsS0FBS0MsU0FBTCxDQUFlO0FBQ3BCQyxxQkFBTyxDQURhO0FBRXBCQyx3QkFBVSxLQUFLckM7QUFGSyxhQUFmO0FBRlQsV0FoRU87QUFIWCxTQURPO0FBSlgsT0FEVztBQUZSLEtBQVA7QUF3RkQ7QUF2TlU7O0FBME5ic0MsT0FBT0MsT0FBUCxHQUFpQnRELE1BQWpCIiwiZmlsZSI6InN1cnZleS5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IG1vbWVudCA9IHJlcXVpcmUoJ21vbWVudCcpXG5jb25zdCBza3lnZWFyID0gcmVxdWlyZSgnc2t5Z2VhcicpXG5jb25zdCB7IERFVkVMT1BNRU5UX01PREUgfSA9IHJlcXVpcmUoJy4vY29uZmlnJylcbmNvbnN0IGRiID0gcmVxdWlyZSgnLi9kYicpXG5jb25zdCBSZXBseSA9IHJlcXVpcmUoJy4vcmVwbHknKVxuXG5jbGFzcyBTdXJ2ZXkge1xuICBjb25zdHJ1Y3RvciAocmVjb3JkKSB7XG4gICAgdGhpcy5fcmVjb3JkID0gcmVjb3JkXG4gIH1cblxuICBzdGF0aWMgZ2V0IFJlY29yZCAoKSB7XG4gICAgcmV0dXJuIHNreWdlYXIuUmVjb3JkLmV4dGVuZCgnc3VydmV5JylcbiAgfVxuXG4gIHN0YXRpYyBjcmVhdGUgKHRlYW1JRCwgZnJlcXVlbmN5LCBleGNsdWRlZFVzZXJzSUQsIHNjaGVkdWxlZERhdGV0aW1lKSB7XG4gICAgbGV0IGlzU2VudCA9IGZhbHNlXG4gICAgbGV0IGlzQ2xvc2VkID0gZmFsc2VcbiAgICBsZXQgcmVjb3JkID0gbmV3IFN1cnZleS5SZWNvcmQoe1xuICAgICAgdGVhbUlELFxuICAgICAgZnJlcXVlbmN5LFxuICAgICAgZXhjbHVkZWRVc2Vyc0lELFxuICAgICAgc2NoZWR1bGVkRGF0ZXRpbWUsXG4gICAgICBpc1NlbnQsXG4gICAgICBpc0Nsb3NlZFxuICAgIH0pXG4gICAgcmV0dXJuIGRiLnNhdmUocmVjb3JkKS50aGVuKHJlY29yZCA9PiBuZXcgU3VydmV5KHJlY29yZCkpXG4gIH1cblxuICBnZXQgaWQgKCkge1xuICAgIHJldHVybiB0aGlzLl9yZWNvcmRbJ2lkJ11cbiAgfVxuXG4gIGdldCB0ZWFtSUQgKCkge1xuICAgIHJldHVybiB0aGlzLl9yZWNvcmRbJ3RlYW1JRCddXG4gIH1cblxuICBnZXQgZnJlcXVlbmN5ICgpIHtcbiAgICByZXR1cm4gdGhpcy5fcmVjb3JkWydmcmVxdWVuY3knXVxuICB9XG5cbiAgZ2V0IGV4Y2x1ZGVkVXNlcnNJRCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsnZXhjbHVkZWRVc2Vyc0lEJ11cbiAgfVxuXG4gIGdldCBzY2hlZHVsZWREYXRldGltZSAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsnc2NoZWR1bGVkRGF0ZXRpbWUnXVxuICB9XG5cbiAgZ2V0IGlzU2VudCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsnaXNTZW50J11cbiAgfVxuXG4gIGdldCBpc0Nsb3NlZCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsnaXNDbG9zZWQnXVxuICB9XG5cbiAgc3RhdGljIG9mIChpZCkge1xuICAgIGxldCBxdWVyeSA9IG5ldyBza3lnZWFyLlF1ZXJ5KFN1cnZleS5SZWNvcmQpXG4gICAgcXVlcnkuZXF1YWxUbygnX2lkJywgaWQpXG4gICAgcmV0dXJuIGRiLnF1ZXJ5KHF1ZXJ5KS50aGVuKHJlc3VsdCA9PiByZXN1bHRbMF0gPyBuZXcgU3VydmV5KHJlc3VsdFswXSkgOiBudWxsKVxuICB9XG5cbiAgc3RhdGljIHNjaGVkdWxlZEJ5ICh0ZWFtSUQpIHtcbiAgICBsZXQgcXVlcnkgPSBuZXcgc2t5Z2Vhci5RdWVyeShTdXJ2ZXkuUmVjb3JkKVxuICAgIHF1ZXJ5LmVxdWFsVG8oJ3RlYW1JRCcsIHRlYW1JRClcbiAgICBxdWVyeS5lcXVhbFRvKCdpc1NlbnQnLCBmYWxzZSlcbiAgICByZXR1cm4gZGIucXVlcnkocXVlcnkpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgIGlmIChyZXN1bHQubGVuZ3RoID4gMSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE11dGlwbGUgc2NoZWR1bGVkIHN1cnZleXMgZm91bmQgZm9yIHRlYW0gJHt0ZWFtSUR9YClcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXN1bHRbMF0gPyBuZXcgU3VydmV5KHJlc3VsdFswXSkgOiBudWxsXG4gICAgfSlcbiAgfVxuXG4gIHN0YXRpYyBvcGVuaW5nSW4gKHRlYW1JRCkge1xuICAgIGxldCBxdWVyeSA9IG5ldyBza3lnZWFyLlF1ZXJ5KFN1cnZleS5SZWNvcmQpXG4gICAgcXVlcnkuZXF1YWxUbygndGVhbUlEJywgdGVhbUlEKVxuICAgIHF1ZXJ5LmVxdWFsVG8oJ2lzU2VudCcsIHRydWUpXG4gICAgcXVlcnkuZXF1YWxUbygnaXNDbG9zZWQnLCBmYWxzZSlcbiAgICByZXR1cm4gZGIucXVlcnkocXVlcnkpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgIGlmIChyZXN1bHQubGVuZ3RoID4gMSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE11dGlwbGUgb3BlbmluZyBzdXJ2ZXlzIGZvdW5kIGZvciB0ZWFtICR7dGVhbUlEfWApXG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzdWx0WzBdID8gbmV3IFN1cnZleShyZXN1bHRbMF0pIDogbnVsbFxuICAgIH0pXG4gIH1cblxuICBzdGF0aWMgZ2V0IHRpbWVUb1NlbmQgKCkge1xuICAgIGxldCBxdWVyeSA9IG5ldyBza3lnZWFyLlF1ZXJ5KFN1cnZleS5SZWNvcmQpXG4gICAgcXVlcnkuZXF1YWxUbygnaXNTZW50JywgZmFsc2UpXG4gICAgcXVlcnkubGVzc1RoYW5PckVxdWFsVG8oJ3NjaGVkdWxlZERhdGV0aW1lJywgbmV3IERhdGUoKSlcbiAgICByZXR1cm4gZGIucXVlcnkocXVlcnkpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgIGxldCByZWNvcmRzID0gW11cbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmVzdWx0Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIHJlY29yZHMucHVzaChuZXcgU3VydmV5KHJlc3VsdFtpXSkpXG4gICAgICB9XG4gICAgICByZXR1cm4gcmVjb3Jkc1xuICAgIH0pXG4gIH1cblxuICBzdGF0aWMgZ2V0IHRpbWVUb0Nsb3NlICgpIHtcbiAgICBsZXQgcXVlcnkgPSBuZXcgc2t5Z2Vhci5RdWVyeShTdXJ2ZXkuUmVjb3JkKVxuICAgIHF1ZXJ5LmVxdWFsVG8oJ2lzU2VudCcsIHRydWUpXG4gICAgcXVlcnkuZXF1YWxUbygnaXNDbG9zZWQnLCBmYWxzZSlcbiAgICBsZXQgdW5pdCA9IERFVkVMT1BNRU5UX01PREUgPyAnc2Vjb25kcycgOiAnaG91cnMnXG4gICAgcXVlcnkuZ3JlYXRlclRoYW5PckVxdWFsVG8oJ3NjaGVkdWxlZERhdGV0aW1lJywgbW9tZW50KCkuc3VidHJhY3QoNDgsIHVuaXQpLnRvRGF0ZSgpKVxuICAgIHJldHVybiBkYi5xdWVyeShxdWVyeSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgbGV0IHJlY29yZHMgPSBbXVxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXN1bHQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgcmVjb3Jkcy5wdXNoKG5ldyBTdXJ2ZXkocmVzdWx0W2ldKSlcbiAgICAgIH1cbiAgICAgIHJldHVybiByZWNvcmRzXG4gICAgfSlcbiAgfVxuXG4gIHNldCBpc1NlbnQgKG5ld1ZhbHVlKSB7XG4gICAgdGhpcy5fcmVjb3JkWydpc1NlbnQnXSA9IG5ld1ZhbHVlXG4gIH1cblxuICBzZXQgaXNDbG9zZWQgKG5ld1ZhbHVlKSB7XG4gICAgdGhpcy5fcmVjb3JkWydpc0Nsb3NlZCddID0gbmV3VmFsdWVcbiAgfVxuXG4gIHVwZGF0ZSAoKSB7XG4gICAgcmV0dXJuIGRiLnNhdmUodGhpcy5fcmVjb3JkKS50aGVuKHJlY29yZCA9PiBuZXcgU3VydmV5KHJlY29yZCkpXG4gIH1cblxuICBnZXQgcmVwbGllcyAoKSB7XG4gICAgcmV0dXJuIFJlcGx5Lm9mKHRoaXMuaWQpXG4gIH1cblxuICBnZXQgcTEgKCkge1xuICAgIHJldHVybiB7XG4gICAgICB0ZXh0OiAnSG93IGxpa2VseSBpcyBpdCB5b3Ugd291bGQgcmVjb21tZW5kIHRoaXMgY29tcGFueSBhcyBhIHBsYWNlIHRvIHdvcms/JyxcbiAgICAgIGF0dGFjaG1lbnRzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICB0ZXh0OiAnQ2hvb3NlIGEgc2NvcmUgZnJvbSAxMCAoaGlnaHRlc3QpIHRvIDEgKGxvd2VzdCknLFxuICAgICAgICAgIGZhbGxiYWNrOiAnWW91IGFyZSB1bmFibGUgdG8gc2VsZWN0IGEgc2NvcmUnLFxuICAgICAgICAgIGNhbGxiYWNrX2lkOiAnc2F2ZVNjb3JlQW5kUmVxdWVzdFJlYXNvbicsXG4gICAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBuYW1lOiAnc2NvcmVzJyxcbiAgICAgICAgICAgICAgdHlwZTogJ3NlbGVjdCcsXG4gICAgICAgICAgICAgIG9wdGlvbnM6IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICB0ZXh0OiAnMTAnLFxuICAgICAgICAgICAgICAgICAgdmFsdWU6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICAgICAgc2NvcmU6IDEwLFxuICAgICAgICAgICAgICAgICAgICBzdXJ2ZXlJRDogdGhpcy5pZFxuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIHRleHQ6ICc5JyxcbiAgICAgICAgICAgICAgICAgIHZhbHVlOiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAgICAgIHNjb3JlOiA5LFxuICAgICAgICAgICAgICAgICAgICBzdXJ2ZXlJRDogdGhpcy5pZFxuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIHRleHQ6ICc4JyxcbiAgICAgICAgICAgICAgICAgIHZhbHVlOiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAgICAgIHNjb3JlOiA4LFxuICAgICAgICAgICAgICAgICAgICBzdXJ2ZXlJRDogdGhpcy5pZFxuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIHRleHQ6ICc3JyxcbiAgICAgICAgICAgICAgICAgIHZhbHVlOiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAgICAgIHNjb3JlOiA3LFxuICAgICAgICAgICAgICAgICAgICBzdXJ2ZXlJRDogdGhpcy5pZFxuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIHRleHQ6ICc2JyxcbiAgICAgICAgICAgICAgICAgIHZhbHVlOiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAgICAgIHNjb3JlOiA2LFxuICAgICAgICAgICAgICAgICAgICBzdXJ2ZXlJRDogdGhpcy5pZFxuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIHRleHQ6ICc1JyxcbiAgICAgICAgICAgICAgICAgIHZhbHVlOiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAgICAgIHNjb3JlOiA1LFxuICAgICAgICAgICAgICAgICAgICBzdXJ2ZXlJRDogdGhpcy5pZFxuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIHRleHQ6ICc0JyxcbiAgICAgICAgICAgICAgICAgIHZhbHVlOiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAgICAgIHNjb3JlOiA0LFxuICAgICAgICAgICAgICAgICAgICBzdXJ2ZXlJRDogdGhpcy5pZFxuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIHRleHQ6ICczJyxcbiAgICAgICAgICAgICAgICAgIHZhbHVlOiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAgICAgIHNjb3JlOiAzLFxuICAgICAgICAgICAgICAgICAgICBzdXJ2ZXlJRDogdGhpcy5pZFxuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIHRleHQ6ICcyJyxcbiAgICAgICAgICAgICAgICAgIHZhbHVlOiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAgICAgIHNjb3JlOiAyLFxuICAgICAgICAgICAgICAgICAgICBzdXJ2ZXlJRDogdGhpcy5pZFxuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIHRleHQ6ICcxJyxcbiAgICAgICAgICAgICAgICAgIHZhbHVlOiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAgICAgIHNjb3JlOiAxLFxuICAgICAgICAgICAgICAgICAgICBzdXJ2ZXlJRDogdGhpcy5pZFxuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIF1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICBdXG4gICAgICAgIH1cbiAgICAgIF1cbiAgICB9XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBTdXJ2ZXlcbiJdfQ==