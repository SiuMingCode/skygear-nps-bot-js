'use strict';

const moment = require('moment');
const skygear = require('skygear');
const { DEVELOPMENT_MODE } = require('./config');
const db = require('./db');
const Reply = require('./reply');

class Survey {
  constructor(record) {
    this._record = record;
  }

  // create
  static get Record() {
    return skygear.Record.extend('survey');
  }

  static create(teamID, frequency, targetsID, scheduledDatetime) {
    let record = new Survey.Record({
      teamID,
      frequency,
      targetsID,
      scheduledDatetime,
      isSent: false,
      isClosed: false
    });
    return db.save(record).then(record => new Survey(record));
  }

  // read
  get id() {
    return this._record['id'];
  }

  get teamID() {
    return this._record['teamID'];
  }

  get frequency() {
    return this._record['frequency'];
  }

  get targetsID() {
    return this._record['targetsID'];
  }

  get scheduledDatetime() {
    return this._record['scheduledDatetime'];
  }

  get isSent() {
    return this._record['isSent'];
  }

  get isClosed() {
    return this._record['isClosed'];
  }

  static of(_id) {
    let query = new skygear.Query(Survey.Record);
    query.equalTo('_id', _id);
    return db.query(query).then(result => result[0] ? new Survey(result[0]) : null);
  }

  static get candidatesOfDistribution() {
    let query = new skygear.Query(Survey.Record);
    query.equalTo('isSent', false);
    // survey.scheduledDatetime == now, time to send
    // survey.scheduledDatetime < now, delayed
    // now < survey.scheduledDatetime, not yet
    // we want delayed or time to send
    // survey.scheduleDate <= now
    // 'scheduleDate' is at lhs
    query.lessThanOrEqualTo('scheduledDatetime', new Date());
    return db.query(query).then(result => {
      let records = [];
      for (let i = 0; i < result.length; i++) {
        records.push(new Survey(result[i]));
      }
      return records;
    });
  }

  static get candidatesOfClosing() {
    let query = new skygear.Query(Survey.Record);
    query.equalTo('isSent', true);
    query.equalTo('isClosed', false);
    // survey.endTime == now, time to close
    // survey.endTime < now, delayed
    // now < survey.endTime, not yet
    // 'scheduleDate' is at lhs
    // we want delayed or time to close
    // survey.endTime <= now, delayed
    // survey.scheduledDatetime + 48 units <= now
    // survey.scheduledDatetime <= now - 48 units
    // 'scheduleDate' is at lhs
    let unit = DEVELOPMENT_MODE ? 'seconds' : 'hours';
    query.lessThanOrEqualTo('scheduledDatetime', moment().subtract(48, unit).toDate());
    return db.query(query).then(result => {
      let records = [];
      for (let i = 0; i < result.length; i++) {
        records.push(new Survey(result[i]));
      }
      return records;
    });
  }

  static get distributed() {
    let query = new skygear.Query(Survey.Record);
    query.equalTo('isSent', true);
    query.equalTo('isClosed', false);
    return db.query(query).then(result => {
      let records = [];
      for (let i = 0; i < result.length; i++) {
        records.push(new Survey(result[i]));
      }
      return records;
    });
  }

  // update

  set isSent(newValue) {
    this._record['isSent'] = newValue;
  }

  set isClosed(newValue) {
    this._record['isClosed'] = newValue;
  }

  update() {
    return db.save(this._record).then(record => new Survey(record));
  }

  // delete

  delete() {
    return db.delete(this._record);
  }

  // misc
  get replies() {
    return Reply.of(this.id);
  }
}

module.exports = Survey;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zdXJ2ZXkuanMiXSwibmFtZXMiOlsibW9tZW50IiwicmVxdWlyZSIsInNreWdlYXIiLCJERVZFTE9QTUVOVF9NT0RFIiwiZGIiLCJSZXBseSIsIlN1cnZleSIsImNvbnN0cnVjdG9yIiwicmVjb3JkIiwiX3JlY29yZCIsIlJlY29yZCIsImV4dGVuZCIsImNyZWF0ZSIsInRlYW1JRCIsImZyZXF1ZW5jeSIsInRhcmdldHNJRCIsInNjaGVkdWxlZERhdGV0aW1lIiwiaXNTZW50IiwiaXNDbG9zZWQiLCJzYXZlIiwidGhlbiIsImlkIiwib2YiLCJfaWQiLCJxdWVyeSIsIlF1ZXJ5IiwiZXF1YWxUbyIsInJlc3VsdCIsImNhbmRpZGF0ZXNPZkRpc3RyaWJ1dGlvbiIsImxlc3NUaGFuT3JFcXVhbFRvIiwiRGF0ZSIsInJlY29yZHMiLCJpIiwibGVuZ3RoIiwicHVzaCIsImNhbmRpZGF0ZXNPZkNsb3NpbmciLCJ1bml0Iiwic3VidHJhY3QiLCJ0b0RhdGUiLCJkaXN0cmlidXRlZCIsIm5ld1ZhbHVlIiwidXBkYXRlIiwiZGVsZXRlIiwicmVwbGllcyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBTUEsU0FBU0MsUUFBUSxRQUFSLENBQWY7QUFDQSxNQUFNQyxVQUFVRCxRQUFRLFNBQVIsQ0FBaEI7QUFDQSxNQUFNLEVBQUVFLGdCQUFGLEtBQXVCRixRQUFRLFVBQVIsQ0FBN0I7QUFDQSxNQUFNRyxLQUFLSCxRQUFRLE1BQVIsQ0FBWDtBQUNBLE1BQU1JLFFBQVFKLFFBQVEsU0FBUixDQUFkOztBQUVBLE1BQU1LLE1BQU4sQ0FBYTtBQUNYQyxjQUFhQyxNQUFiLEVBQXFCO0FBQ25CLFNBQUtDLE9BQUwsR0FBZUQsTUFBZjtBQUNEOztBQUVEO0FBQ0EsYUFBV0UsTUFBWCxHQUFxQjtBQUNuQixXQUFPUixRQUFRUSxNQUFSLENBQWVDLE1BQWYsQ0FBc0IsUUFBdEIsQ0FBUDtBQUNEOztBQUVELFNBQU9DLE1BQVAsQ0FBZUMs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LElBQUgsQ0FBUSxLQUFLVixPQUFiLEVBQXNCVyxJQUF0QixDQUEyQlosVUFBVSxJQUFJRixNQUFKLENBQVdFLE1BQVgsQ0FBckMsQ0FBUDtBQUNEOztBQUVEOztBQUVBa0MsV0FBVTtBQUNSLFdBQU90QyxHQUFHc0MsTUFBSCxDQUFVLEtBQUtqQyxPQUFmLENBQVA7QUFDRDs7QUFFRDtBQUNBLE1BQUlrQyxPQUFKLEdBQWU7QUFDYixXQUFPdEMsTUFBTWlCLEVBQU4sQ0FBUyxLQUFLRCxFQUFkLENBQVA7QUFDRDtBQXhJVTs7QUEySWJ1QixPQUFPQyxPQUFQLEdBQWlCdkMsTUFBakIiLCJmaWxlIjoic3VydmV5LmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgbW9tZW50ID0gcmVxdWlyZSgnbW9tZW50JylcbmNvbnN0IHNreWdlYXIgPSByZXF1aXJlKCdza3lnZWFyJylcbmNvbnN0IHsgREVWRUxPUE1FTlRfTU9ERSB9ID0gcmVxdWlyZSgnLi9jb25maWcnKVxuY29uc3QgZGIgPSByZXF1aXJlKCcuL2RiJylcbmNvbnN0IFJlcGx5ID0gcmVxdWlyZSgnLi9yZXBseScpXG5cbmNsYXNzIFN1cnZleSB7XG4gIGNvbnN0cnVjdG9yIChyZWNvcmQpIHtcbiAgICB0aGlzLl9yZWNvcmQgPSByZWNvcmRcbiAgfVxuXG4gIC8vIGNyZWF0ZVxuICBzdGF0aWMgZ2V0IFJlY29yZCAoKSB7XG4gICAgcmV0dXJuIHNreWdlYXIuUmVjb3JkLmV4dGVuZCgnc3VydmV5JylcbiAgfVxuXG4gIHN0YXRpYyBjcmVhdGUgKHRlYW1JRCwgZnJlcXVlbmN5LCB0YXJnZXRzSUQsIHNjaGVkdWxlZERhdGV0aW1lKSB7XG4gICAgbGV0IHJlY29yZCA9IG5ldyBTdXJ2ZXkuUmVjb3JkKHtcbiAgICAgIHRlYW1JRCxcbiAgICAgIGZyZXF1ZW5jeSxcbiAgICAgIHRhcmdldHNJRCxcbiAgICAgIHNjaGVkdWxlZERhdGV0aW1lLFxuICAgICAgaXNTZW50OiBmYWxzZSxcbiAgICAgIGlzQ2xvc2VkOiBmYWxzZVxuICAgIH0pXG4gICAgcmV0dXJuIGRiLnNhdmUocmVjb3JkKS50aGVuKHJlY29yZCA9PiBuZXcgU3VydmV5KHJlY29yZCkpXG4gIH1cblxuICAvLyByZWFkXG4gIGdldCBpZCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsnaWQnXVxuICB9XG5cbiAgZ2V0IHRlYW1JRCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsndGVhbUlEJ11cbiAgfVxuXG4gIGdldCBmcmVxdWVuY3kgKCkge1xuICAgIHJldHVybiB0aGlzLl9yZWNvcmRbJ2ZyZXF1ZW5jeSddXG4gIH1cblxuICBnZXQgdGFyZ2V0c0lEICgpIHtcbiAgICByZXR1cm4gdGhpcy5fcmVjb3JkWyd0YXJnZXRzSUQnXVxuICB9XG5cbiAgZ2V0IHNjaGVkdWxlZERhdGV0aW1lICgpIHtcbiAgICByZXR1cm4gdGhpcy5fcmVjb3JkWydzY2hlZHVsZWREYXRldGltZSddXG4gIH1cblxuICBnZXQgaXNTZW50ICgpIHtcbiAgICByZXR1cm4gdGhpcy5fcmVjb3JkWydpc1NlbnQnXVxuICB9XG5cbiAgZ2V0IGlzQ2xvc2VkICgpIHtcbiAgICByZXR1cm4gdGhpcy5fcmVjb3JkWydpc0Nsb3NlZCddXG4gIH1cblxuICBzdGF0aWMgb2YgKF9pZCkge1xuICAgIGxldCBxdWVyeSA9IG5ldyBza3lnZWFyLlF1ZXJ5KFN1cnZleS5SZWNvcmQpXG4gICAgcXVlcnkuZXF1YWxUbygnX2lkJywgX2lkKVxuICAgIHJldHVybiBkYi5xdWVyeShxdWVyeSkudGhlbihyZXN1bHQgPT4gcmVzdWx0WzBdID8gbmV3IFN1cnZleShyZXN1bHRbMF0pIDogbnVsbClcbiAgfVxuXG4gIHN0YXRpYyBnZXQgY2FuZGlkYXRlc09mRGlzdHJpYnV0aW9uICgpIHtcbiAgICBsZXQgcXVlcnkgPSBuZXcgc2t5Z2Vhci5RdWVyeShTdXJ2ZXkuUmVjb3JkKVxuICAgIHF1ZXJ5LmVxdWFsVG8oJ2lzU2VudCcsIGZhbHNlKVxuICAgIC8vIHN1cnZleS5zY2hlZHVsZWREYXRldGltZSA9PSBub3csIHRpbWUgdG8gc2VuZFxuICAgIC8vIHN1cnZleS5zY2hlZHVsZWREYXRldGltZSA8IG5vdywgZGVsYXllZFxuICAgIC8vIG5vdyA8IHN1cnZleS5zY2hlZHVsZWREYXRldGltZSwgbm90IHlldFxuICAgIC8vIHdlIHdhbnQgZGVsYXllZCBvciB0aW1lIHRvIHNlbmRcbiAgICAvLyBzdXJ2ZXkuc2NoZWR1bGVEYXRlIDw9IG5vd1xuICAgIC8vICdzY2hlZHVsZURhdGUnIGlzIGF0IGxoc1xuICAgIHF1ZXJ5Lmxlc3NUaGFuT3JFcXVhbFRvKCdzY2hlZHVsZWREYXRldGltZScsIG5ldyBEYXRlKCkpXG4gICAgcmV0dXJuIGRiLnF1ZXJ5KHF1ZXJ5KS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICBsZXQgcmVjb3JkcyA9IFtdXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc3VsdC5sZW5ndGg7IGkrKykge1xuICAgICAgICByZWNvcmRzLnB1c2gobmV3IFN1cnZleShyZXN1bHRbaV0pKVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlY29yZHNcbiAgICB9KVxuICB9XG5cbiAgc3RhdGljIGdldCBjYW5kaWRhdGVzT2ZDbG9zaW5nICgpIHtcbiAgICBsZXQgcXVlcnkgPSBuZXcgc2t5Z2Vhci5RdWVyeShTdXJ2ZXkuUmVjb3JkKVxuICAgIHF1ZXJ5LmVxdWFsVG8oJ2lzU2VudCcsIHRydWUpXG4gICAgcXVlcnkuZXF1YWxUbygnaXNDbG9zZWQnLCBmYWxzZSlcbiAgICAvLyBzdXJ2ZXkuZW5kVGltZSA9PSBub3csIHRpbWUgdG8gY2xvc2VcbiAgICAvLyBzdXJ2ZXkuZW5kVGltZSA8IG5vdywgZGVsYXllZFxuICAgIC8vIG5vdyA8IHN1cnZleS5lbmRUaW1lLCBub3QgeWV0XG4gICAgLy8gJ3NjaGVkdWxlRGF0ZScgaXMgYXQgbGhzXG4gICAgLy8gd2Ugd2FudCBkZWxheWVkIG9yIHRpbWUgdG8gY2xvc2VcbiAgICAvLyBzdXJ2ZXkuZW5kVGltZSA8PSBub3csIGRlbGF5ZWRcbiAgICAvLyBzdXJ2ZXkuc2NoZWR1bGVkRGF0ZXRpbWUgKyA0OCB1bml0cyA8PSBub3dcbiAgICAvLyBzdXJ2ZXkuc2NoZWR1bGVkRGF0ZXRpbWUgPD0gbm93IC0gNDggdW5pdHNcbiAgICAvLyAnc2NoZWR1bGVEYXRlJyBpcyBhdCBsaHNcbiAgICBsZXQgdW5pdCA9IERFVkVMT1BNRU5UX01PREUgPyAnc2Vjb25kcycgOiAnaG91cnMnXG4gICAgcXVlcnkubGVzc1RoYW5PckVxdWFsVG8oJ3NjaGVkdWxlZERhdGV0aW1lJywgbW9tZW50KCkuc3VidHJhY3QoNDgsIHVuaXQpLnRvRGF0ZSgpKVxuICAgIHJldHVybiBkYi5xdWVyeShxdWVyeSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgbGV0IHJlY29yZHMgPSBbXVxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXN1bHQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgcmVjb3Jkcy5wdXNoKG5ldyBTdXJ2ZXkocmVzdWx0W2ldKSlcbiAgICAgIH1cbiAgICAgIHJldHVybiByZWNvcmRzXG4gICAgfSlcbiAgfVxuXG4gIHN0YXRpYyBnZXQgZGlzdHJpYnV0ZWQgKCkge1xuICAgIGxldCBxdWVyeSA9IG5ldyBza3lnZWFyLlF1ZXJ5KFN1cnZleS5SZWNvcmQpXG4gICAgcXVlcnkuZXF1YWxUbygnaXNTZW50JywgdHJ1ZSlcbiAgICBxdWVyeS5lcXVhbFRvKCdpc0Nsb3NlZCcsIGZhbHNlKVxuICAgIHJldHVybiBkYi5xdWVyeShxdWVyeSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgbGV0IHJlY29yZHMgPSBbXVxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXN1bHQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgcmVjb3Jkcy5wdXNoKG5ldyBTdXJ2ZXkocmVzdWx0W2ldKSlcbiAgICAgIH1cbiAgICAgIHJldHVybiByZWNvcmRzXG4gICAgfSlcbiAgfVxuXG4gIC8vIHVwZGF0ZVxuXG4gIHNldCBpc1NlbnQgKG5ld1ZhbHVlKSB7XG4gICAgdGhpcy5fcmVjb3JkWydpc1NlbnQnXSA9IG5ld1ZhbHVlXG4gIH1cblxuICBzZXQgaXNDbG9zZWQgKG5ld1ZhbHVlKSB7XG4gICAgdGhpcy5fcmVjb3JkWydpc0Nsb3NlZCddID0gbmV3VmFsdWVcbiAgfVxuXG4gIHVwZGF0ZSAoKSB7XG4gICAgcmV0dXJuIGRiLnNhdmUodGhpcy5fcmVjb3JkKS50aGVuKHJlY29yZCA9PiBuZXcgU3VydmV5KHJlY29yZCkpXG4gIH1cblxuICAvLyBkZWxldGVcblxuICBkZWxldGUgKCkge1xuICAgIHJldHVybiBkYi5kZWxldGUodGhpcy5fcmVjb3JkKVxuICB9XG5cbiAgLy8gbWlzY1xuICBnZXQgcmVwbGllcyAoKSB7XG4gICAgcmV0dXJuIFJlcGx5Lm9mKHRoaXMuaWQpXG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBTdXJ2ZXlcbiJdfQ==