'use strict';

const skygear = require('skygear');
const db = require('./db');

class Survey {
  constructor(record) {
    this._record = record;
  }

  static get Record() {
    return skygear.Record.extend('survey');
  }

  static create(teamID, frequency, excludedUsersID, scheduledDatetime) {
    let isSent = false;
    let isClosed = false;
    let record = new Survey.Record({
      teamID,
      frequency,
      excludedUsersID,
      scheduledDatetime,
      isSent,
      isClosed
    });
    return db.save(record).then(record => new Survey(record));
  }

  static of(id) {
    let query = new skygear.Query(Survey.Record);
    query.equalTo('_id', id);
    return db.query(query).then(result => result[0] ? new Survey(result[0]) : null);
  }

  static scheduledBy(teamID) {
    let query = new skygear.Query(Survey.Record);
    query.equalTo('teamID', teamID);
    query.equalTo('isSent', false);
    return db.query(query).then(result => {
      if (result.length > 1) {
        throw new Error(`Mutiple scheduled surveys found for team ${teamID}`);
      }
      return result[0] ? new Survey(result[0]) : null;
    });
  }

  static get readyToSend() {
    let query = new skygear.Query(Survey.Record);
    query.equalTo('isSent', false);
    query.lessThanOrEqualTo('scheduledDatetime', new Date());
    return db.query(query).then(result => {
      let records = [];
      for (let i = 0; i < result.length; i++) {
        records.push(new Survey(result[i]));
      }
      return records;
    });
  }

  set isSent(newValue) {
    this._record['isSent'] = newValue;
  }

  update() {
    return db.save(this._record).then(record => new Survey(record));
  }

  get id() {
    return this._record['id'];
  }

  get teamID() {
    return this._record['teamID'];
  }

  get frequency() {
    return this._record['frequency'];
  }

  get excludedUsersID() {
    return this._record['excludedUsersID'];
  }

  get scheduledDatetime() {
    return this._record['scheduledDatetime'];
  }

  get isSent() {
    return this._record['isSent'];
  }

  get isClosed() {
    return this._record['isClosed'];
  }

  get q1() {
    return {
      text: 'How likely is it you would recommend this company as a place to work?',
      attachments: [{
        text: 'Choose a score from 10 (hightest) to 1 (lowest)',
        fallback: 'You are unable to select a score',
        callback_id: 'saveScoreAndRequestReason',
        actions: [{
          name: 'scores',
          type: 'select',
          options: [{
            text: '10',
            value: JSON.stringify({
              score: 10,
              surveyID: this.id
            })
          }]
        }]
      }]
    };
  }
}

module.exports = Survey;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zdXJ2ZXkuanMiXSwibmFtZXMiOlsic2t5Z2VhciIsInJlcXVpcmUiLCJkYiIsIlN1cnZleSIsImNvbnN0cnVjdG9yIiwicmVjb3JkIiwiX3JlY29yZCIsIlJlY29yZCIsImV4dGVuZCIsImNyZWF0ZSIsInRlYW1JRCIsImZyZXF1ZW5jeSIsImV4Y2x1ZGVkVXNlcnNJRCIsInNjaGVkdWxlZERhdGV0aW1lIiwiaXNTZW50IiwiaXNDbG9zZWQiLCJzYXZlIiwidGhlbiIsIm9mIiwiaWQiLCJxdWVyeSIsIlF1ZXJ5IiwiZXF1YWxUbyIsInJlc3VsdCIsInNjaGVkdWxlZEJ5IiwibGVuZ3RoIiwiRXJyb3IiLCJyZWFkeVRvU2VuZCIsImxlc3NUaGFuT3JFcXVhbFRvIiwiRGF0ZSIsInJlY29yZHMiLCJpIiwicHVzaCIsIm5ld1ZhbHVlIiwidXBkYXRlIiwicTEiLCJ0ZXh0IiwiYXR0YWNobWVudHMiLCJmYWxsYmFjayIsImNhbGxiYWNrX2lkIiwiYWN0aW9ucyIsIm5hbWUiLCJ0eXBlIiwib3B0aW9ucyIsInZhbHVlIiwiSlNPTiIsInN0cmluZ2lmeSIsInNjb3JlIiwic3VydmV5SUQiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU1BLFVBQVVDLFFBQVEsU0FBUixDQUFoQjtBQUNBLE1BQU1DLEtBQUtELFFBQVEsTUFBUixDQUFYOztBQUVBLE1BQU1FLE1BQU4sQ0FBYTtBQUNYQyxjQUFhQyxNQUFiLEVBQXFCO0FBQ25CLFNBQUtDLE9BQUwsR0FBZUQsTUFBZjtBQUNEOztBQUVELGFBQVdFLE1BQVgsR0FBcUI7QUFDbkIsV0FBT1AsUUFBUU8sTUFBUixDQUFlQyxNQUFmLENBQXNCLFFBQXRCLENBQVA7QUFDRDs7QUFFRCxTQUFPQyxNQUFQLENBQWVDLE1BQWYsRUFBdUJDLFNBQXZCLEVBQWtDQyxlQUFsQyxFQUFtREMsaUJBQW5ELEVBQXNFO0FBQ3BFLFFBQUlDLFNBQVMsS0FBYjtBQUNBLFFBQUlDLFdBQVcsS0FB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aUJBQWIsQ0FBUDtBQUNEOztBQUVELE1BQUlPLGlCQUFKLEdBQXlCO0FBQ3ZCLFdBQU8sS0FBS1AsT0FBTCxDQUFhLG1CQUFiLENBQVA7QUFDRDs7QUFFRCxNQUFJUSxNQUFKLEdBQWM7QUFDWixXQUFPLEtBQUtSLE9BQUwsQ0FBYSxRQUFiLENBQVA7QUFDRDs7QUFFRCxNQUFJUyxRQUFKLEdBQWdCO0FBQ2QsV0FBTyxLQUFLVCxPQUFMLENBQWEsVUFBYixDQUFQO0FBQ0Q7O0FBRUQsTUFBSTZCLEVBQUosR0FBVTtBQUNSLFdBQU87QUFDTEMsWUFBTSx1RUFERDtBQUVMQyxtQkFBYSxDQUNYO0FBQ0VELGNBQU0saURBRFI7QUFFRUUsa0JBQVUsa0NBRlo7QUFHRUMscUJBQWEsMkJBSGY7QUFJRUMsaUJBQVMsQ0FDUDtBQUNFQyxnQkFBTSxRQURSO0FBRUVDLGdCQUFNLFFBRlI7QUFHRUMsbUJBQVMsQ0FDUDtBQUNFUCxrQkFBTSxJQURSO0FBRUVRLG1CQUFPQyxLQUFLQyxTQUFMLENBQWU7QUFDcEJDLHFCQUFPLEVBRGE7QUFFcEJDLHdCQUFVLEtBQUs3QjtBQUZLLGFBQWY7QUFGVCxXQURPO0FBSFgsU0FETztBQUpYLE9BRFc7QUFGUixLQUFQO0FBeUJEO0FBcEhVOztBQXVIYjhCLE9BQU9DLE9BQVAsR0FBaUIvQyxNQUFqQiIsImZpbGUiOiJzdXJ2ZXkuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBza3lnZWFyID0gcmVxdWlyZSgnc2t5Z2VhcicpXG5jb25zdCBkYiA9IHJlcXVpcmUoJy4vZGInKVxuXG5jbGFzcyBTdXJ2ZXkge1xuICBjb25zdHJ1Y3RvciAocmVjb3JkKSB7XG4gICAgdGhpcy5fcmVjb3JkID0gcmVjb3JkXG4gIH1cblxuICBzdGF0aWMgZ2V0IFJlY29yZCAoKSB7XG4gICAgcmV0dXJuIHNreWdlYXIuUmVjb3JkLmV4dGVuZCgnc3VydmV5JylcbiAgfVxuXG4gIHN0YXRpYyBjcmVhdGUgKHRlYW1JRCwgZnJlcXVlbmN5LCBleGNsdWRlZFVzZXJzSUQsIHNjaGVkdWxlZERhdGV0aW1lKSB7XG4gICAgbGV0IGlzU2VudCA9IGZhbHNlXG4gICAgbGV0IGlzQ2xvc2VkID0gZmFsc2VcbiAgICBsZXQgcmVjb3JkID0gbmV3IFN1cnZleS5SZWNvcmQoe1xuICAgICAgdGVhbUlELFxuICAgICAgZnJlcXVlbmN5LFxuICAgICAgZXhjbHVkZWRVc2Vyc0lELFxuICAgICAgc2NoZWR1bGVkRGF0ZXRpbWUsXG4gICAgICBpc1NlbnQsXG4gICAgICBpc0Nsb3NlZFxuICAgIH0pXG4gICAgcmV0dXJuIGRiLnNhdmUocmVjb3JkKS50aGVuKHJlY29yZCA9PiBuZXcgU3VydmV5KHJlY29yZCkpXG4gIH1cblxuICBzdGF0aWMgb2YgKGlkKSB7XG4gICAgbGV0IHF1ZXJ5ID0gbmV3IHNreWdlYXIuUXVlcnkoU3VydmV5LlJlY29yZClcbiAgICBxdWVyeS5lcXVhbFRvKCdfaWQnLCBpZClcbiAgICByZXR1cm4gZGIucXVlcnkocXVlcnkpLnRoZW4ocmVzdWx0ID0+IHJlc3VsdFswXSA/IG5ldyBTdXJ2ZXkocmVzdWx0WzBdKSA6IG51bGwpXG4gIH1cblxuICBzdGF0aWMgc2NoZWR1bGVkQnkgKHRlYW1JRCkge1xuICAgIGxldCBxdWVyeSA9IG5ldyBza3lnZWFyLlF1ZXJ5KFN1cnZleS5SZWNvcmQpXG4gICAgcXVlcnkuZXF1YWxUbygndGVhbUlEJywgdGVhbUlEKVxuICAgIHF1ZXJ5LmVxdWFsVG8oJ2lzU2VudCcsIGZhbHNlKVxuICAgIHJldHVybiBkYi5xdWVyeShxdWVyeSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgaWYgKHJlc3VsdC5sZW5ndGggPiAxKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTXV0aXBsZSBzY2hlZHVsZWQgc3VydmV5cyBmb3VuZCBmb3IgdGVhbSAke3RlYW1JRH1gKVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3VsdFswXSA/IG5ldyBTdXJ2ZXkocmVzdWx0WzBdKSA6IG51bGxcbiAgICB9KVxuICB9XG5cbiAgc3RhdGljIGdldCByZWFkeVRvU2VuZCAoKSB7XG4gICAgbGV0IHF1ZXJ5ID0gbmV3IHNreWdlYXIuUXVlcnkoU3VydmV5LlJlY29yZClcbiAgICBxdWVyeS5lcXVhbFRvKCdpc1NlbnQnLCBmYWxzZSlcbiAgICBxdWVyeS5sZXNzVGhhbk9yRXF1YWxUbygnc2NoZWR1bGVkRGF0ZXRpbWUnLCBuZXcgRGF0ZSgpKVxuICAgIHJldHVybiBkYi5xdWVyeShxdWVyeSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgbGV0IHJlY29yZHMgPSBbXVxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXN1bHQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgcmVjb3Jkcy5wdXNoKG5ldyBTdXJ2ZXkocmVzdWx0W2ldKSlcbiAgICAgIH1cbiAgICAgIHJldHVybiByZWNvcmRzXG4gICAgfSlcbiAgfVxuXG4gIHNldCBpc1NlbnQgKG5ld1ZhbHVlKSB7XG4gICAgdGhpcy5fcmVjb3JkWydpc1NlbnQnXSA9IG5ld1ZhbHVlXG4gIH1cblxuICB1cGRhdGUgKCkge1xuICAgIHJldHVybiBkYi5zYXZlKHRoaXMuX3JlY29yZCkudGhlbihyZWNvcmQgPT4gbmV3IFN1cnZleShyZWNvcmQpKVxuICB9XG5cbiAgZ2V0IGlkICgpIHtcbiAgICByZXR1cm4gdGhpcy5fcmVjb3JkWydpZCddXG4gIH1cblxuICBnZXQgdGVhbUlEICgpIHtcbiAgICByZXR1cm4gdGhpcy5fcmVjb3JkWyd0ZWFtSUQnXVxuICB9XG5cbiAgZ2V0IGZyZXF1ZW5jeSAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsnZnJlcXVlbmN5J11cbiAgfVxuXG4gIGdldCBleGNsdWRlZFVzZXJzSUQgKCkge1xuICAgIHJldHVybiB0aGlzLl9yZWNvcmRbJ2V4Y2x1ZGVkVXNlcnNJRCddXG4gIH1cblxuICBnZXQgc2NoZWR1bGVkRGF0ZXRpbWUgKCkge1xuICAgIHJldHVybiB0aGlzLl9yZWNvcmRbJ3NjaGVkdWxlZERhdGV0aW1lJ11cbiAgfVxuXG4gIGdldCBpc1NlbnQgKCkge1xuICAgIHJldHVybiB0aGlzLl9yZWNvcmRbJ2lzU2VudCddXG4gIH1cblxuICBnZXQgaXNDbG9zZWQgKCkge1xuICAgIHJldHVybiB0aGlzLl9yZWNvcmRbJ2lzQ2xvc2VkJ11cbiAgfVxuXG4gIGdldCBxMSAoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRleHQ6ICdIb3cgbGlrZWx5IGlzIGl0IHlvdSB3b3VsZCByZWNvbW1lbmQgdGhpcyBjb21wYW55IGFzIGEgcGxhY2UgdG8gd29yaz8nLFxuICAgICAgYXR0YWNobWVudHM6IFtcbiAgICAgICAge1xuICAgICAgICAgIHRleHQ6ICdDaG9vc2UgYSBzY29yZSBmcm9tIDEwIChoaWdodGVzdCkgdG8gMSAobG93ZXN0KScsXG4gICAgICAgICAgZmFsbGJhY2s6ICdZb3UgYXJlIHVuYWJsZSB0byBzZWxlY3QgYSBzY29yZScsXG4gICAgICAgICAgY2FsbGJhY2tfaWQ6ICdzYXZlU2NvcmVBbmRSZXF1ZXN0UmVhc29uJyxcbiAgICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIG5hbWU6ICdzY29yZXMnLFxuICAgICAgICAgICAgICB0eXBlOiAnc2VsZWN0JyxcbiAgICAgICAgICAgICAgb3B0aW9uczogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIHRleHQ6ICcxMCcsXG4gICAgICAgICAgICAgICAgICB2YWx1ZTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgICAgICAgICBzY29yZTogMTAsXG4gICAgICAgICAgICAgICAgICAgIHN1cnZleUlEOiB0aGlzLmlkXG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgfVxuICAgICAgICAgIF1cbiAgICAgICAgfVxuICAgICAgXVxuICAgIH1cbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFN1cnZleVxuIl19