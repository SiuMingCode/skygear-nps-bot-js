'use strict';

const skygear = require('skygear');
const db = require('./db');

class Survey {
  constructor(record) {
    this._record = record;
  }

  static get Record() {
    return skygear.Record.extend('survey');
  }

  static create(teamID, frequency, excludedUsersID, scheduledDatetime) {
    let isSent = false;
    let isClosed = false;
    let record = new Survey.Record({
      teamID,
      frequency,
      excludedUsersID,
      scheduledDatetime,
      isSent,
      isClosed
    });
    return db.save(record).then(record => new Survey(record));
  }

  static of(id) {
    let query = new skygear.Query(Survey.Record);
    query.equalTo('_id', id);
    return db.query(query).then(result => result[0] ? new Survey(result[0]) : null);
  }

  static scheduledBy(teamID) {
    let query = new skygear.Query(Survey.Record);
    query.equalTo('teamID', teamID);
    query.equalTo('isSent', false);
    return db.query(query).then(result => {
      if (result.length > 1) {
        throw new Error(`Mutiple scheduled surveys found for team ${teamID}`);
      }
      return result[0] ? new Survey(result[0]) : null;
    });
  }

  static openingIn(teamID) {
    let query = new skygear.Query(Survey.Record);
    query.equalTo('teamID', teamID);
    query.equalTo('isSent', true);
    query.equalTo('isClosed', false);
    return db.query(query).then(result => {
      if (result.length > 1) {
        throw new Error(`Mutiple opening surveys found for team ${teamID}`);
      }
      return result[0] ? new Survey(result[0]) : null;
    });
  }

  static get readyToSend() {
    let query = new skygear.Query(Survey.Record);
    query.equalTo('isSent', false);
    query.lessThanOrEqualTo('scheduledDatetime', new Date());
    return db.query(query).then(result => {
      let records = [];
      for (let i = 0; i < result.length; i++) {
        records.push(new Survey(result[i]));
      }
      return records;
    });
  }

  set isSent(newValue) {
    this._record['isSent'] = newValue;
  }

  update() {
    return db.save(this._record).then(record => new Survey(record));
  }

  get id() {
    return this._record['id'];
  }

  get teamID() {
    return this._record['teamID'];
  }

  get frequency() {
    return this._record['frequency'];
  }

  get excludedUsersID() {
    return this._record['excludedUsersID'];
  }

  get scheduledDatetime() {
    return this._record['scheduledDatetime'];
  }

  get isSent() {
    return this._record['isSent'];
  }

  get isClosed() {
    return this._record['isClosed'];
  }

  get state() {
    if (!this.isSent && !this.isClosed) {
      return 'scheduled';
    } else if (this.isSent && !this.isClosed) {
      return 'open';
    } else if (this.isSent && !this.isClosed) {
      return 'closed';
    } else {
      throw new Error('Invalid survey state');
    }
  }

  get q1() {
    return {
      text: 'How likely is it you would recommend this company as a place to work?',
      attachments: [{
        text: 'Choose a score from 10 (hightest) to 1 (lowest)',
        fallback: 'You are unable to select a score',
        callback_id: 'saveScoreAndRequestReason',
        actions: [{
          name: 'scores',
          type: 'select',
          options: [{
            text: '10',
            value: JSON.stringify({
              score: 10,
              surveyID: this.id
            })
          }, {
            text: '9',
            value: JSON.stringify({
              score: 9,
              surveyID: this.id
            })
          }, {
            text: '8',
            value: JSON.stringify({
              score: 8,
              surveyID: this.id
            })
          }, {
            text: '7',
            value: JSON.stringify({
              score: 7,
              surveyID: this.id
            })
          }, {
            text: '6',
            value: JSON.stringify({
              score: 6,
              surveyID: this.id
            })
          }, {
            text: '5',
            value: JSON.stringify({
              score: 5,
              surveyID: this.id
            })
          }, {
            text: '4',
            value: JSON.stringify({
              score: 4,
              surveyID: this.id
            })
          }, {
            text: '3',
            value: JSON.stringify({
              score: 3,
              surveyID: this.id
            })
          }, {
            text: '2',
            value: JSON.stringify({
              score: 2,
              surveyID: this.id
            })
          }, {
            text: '1',
            value: JSON.stringify({
              score: 1,
              surveyID: this.id
            })
          }]
        }]
      }]
    };
  }
}

module.exports = Survey;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zdXJ2ZXkuanMiXSwibmFtZXMiOlsic2t5Z2VhciIsInJlcXVpcmUiLCJkYiIsIlN1cnZleSIsImNvbnN0cnVjdG9yIiwicmVjb3JkIiwiX3JlY29yZCIsIlJlY29yZCIsImV4dGVuZCIsImNyZWF0ZSIsInRlYW1JRCIsImZyZXF1ZW5jeSIsImV4Y2x1ZGVkVXNlcnNJRCIsInNjaGVkdWxlZERhdGV0aW1lIiwiaXNTZW50IiwiaXNDbG9zZWQiLCJzYXZlIiwidGhlbiIsIm9mIiwiaWQiLCJxdWVyeSIsIlF1ZXJ5IiwiZXF1YWxUbyIsInJlc3VsdCIsInNjaGVkdWxlZEJ5IiwibGVuZ3RoIiwiRXJyb3IiLCJvcGVuaW5nSW4iLCJyZWFkeVRvU2VuZCIsImxlc3NUaGFuT3JFcXVhbFRvIiwiRGF0ZSIsInJlY29yZHMiLCJpIiwicHVzaCIsIm5ld1ZhbHVlIiwidXBkYXRlIiwic3RhdGUiLCJxMSIsInRleHQiLCJhdHRhY2htZW50cyIsImZhbGxiYWNrIiwiY2FsbGJhY2tfaWQiLCJhY3Rpb25zIiwibmFtZSIsInR5cGUiLCJvcHRpb25zIiwidmFsdWUiLCJKU09OIiwic3RyaW5naWZ5Iiwic2NvcmUiLCJzdXJ2ZXlJRCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBTUEsVUFBVUMsUUFBUSxTQUFSLENBQWhCO0FBQ0EsTUFBTUMsS0FBS0QsUUFBUSxNQUFSLENBQVg7O0FBRUEsTUFBTUUsTUFBTixDQUFhO0FBQ1hDLGNBQWFDLE1BQWIsRUFBcUI7QUFDbkIsU0FBS0MsT0FBTCxHQUFlRCxNQUFmO0FBQ0Q7O0FBRUQsYUFBV0UsTUFBWCxHQUFxQjtBQUNuQixXQUFPUCxRQUFRTyxNQUFSLENBQWVDLE1BQWYsQ0FBc0IsUUFBdEIsQ0FBUDtBQUNEOztBQUVELFNBQU9DLE1BQVAsQ0FBZUMsTUFBZixFQUF1QkMsU0FBdkIsRUFBa0NDLGVBQWxDLEVBQW1EQyxpQkFBbkQsRUFBc0U7QUFDcEUsUUFBSUMsU0FBUyxLQUFi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QkMscUJBQU8sQ0FEYTtBQUVwQkMsd0JBQVUsS0FBSy9CO0FBRkssYUFBZjtBQUZULFdBcENPLEVBMkNQO0FBQ0VtQixrQkFBTSxHQURSO0FBRUVRLG1CQUFPQyxLQUFLQyxTQUFMLENBQWU7QUFDcEJDLHFCQUFPLENBRGE7QUFFcEJDLHdCQUFVLEtBQUsvQjtBQUZLLGFBQWY7QUFGVCxXQTNDTyxFQWtEUDtBQUNFbUIsa0JBQU0sR0FEUjtBQUVFUSxtQkFBT0MsS0FBS0MsU0FBTCxDQUFlO0FBQ3BCQyxxQkFBTyxDQURhO0FBRXBCQyx3QkFBVSxLQUFLL0I7QUFGSyxhQUFmO0FBRlQsV0FsRE8sRUF5RFA7QUFDRW1CLGtCQUFNLEdBRFI7QUFFRVEsbUJBQU9DLEtBQUtDLFNBQUwsQ0FBZTtBQUNwQkMscUJBQU8sQ0FEYTtBQUVwQkMsd0JBQVUsS0FBSy9CO0FBRkssYUFBZjtBQUZULFdBekRPLEVBZ0VQO0FBQ0VtQixrQkFBTSxHQURSO0FBRUVRLG1CQUFPQyxLQUFLQyxTQUFMLENBQWU7QUFDcEJDLHFCQUFPLENBRGE7QUFFcEJDLHdCQUFVLEtBQUsvQjtBQUZLLGFBQWY7QUFGVCxXQWhFTztBQUhYLFNBRE87QUFKWCxPQURXO0FBRlIsS0FBUDtBQXdGRDtBQTVNVTs7QUErTWJnQyxPQUFPQyxPQUFQLEdBQWlCakQsTUFBakIiLCJmaWxlIjoic3VydmV5LmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3Qgc2t5Z2VhciA9IHJlcXVpcmUoJ3NreWdlYXInKVxuY29uc3QgZGIgPSByZXF1aXJlKCcuL2RiJylcblxuY2xhc3MgU3VydmV5IHtcbiAgY29uc3RydWN0b3IgKHJlY29yZCkge1xuICAgIHRoaXMuX3JlY29yZCA9IHJlY29yZFxuICB9XG5cbiAgc3RhdGljIGdldCBSZWNvcmQgKCkge1xuICAgIHJldHVybiBza3lnZWFyLlJlY29yZC5leHRlbmQoJ3N1cnZleScpXG4gIH1cblxuICBzdGF0aWMgY3JlYXRlICh0ZWFtSUQsIGZyZXF1ZW5jeSwgZXhjbHVkZWRVc2Vyc0lELCBzY2hlZHVsZWREYXRldGltZSkge1xuICAgIGxldCBpc1NlbnQgPSBmYWxzZVxuICAgIGxldCBpc0Nsb3NlZCA9IGZhbHNlXG4gICAgbGV0IHJlY29yZCA9IG5ldyBTdXJ2ZXkuUmVjb3JkKHtcbiAgICAgIHRlYW1JRCxcbiAgICAgIGZyZXF1ZW5jeSxcbiAgICAgIGV4Y2x1ZGVkVXNlcnNJRCxcbiAgICAgIHNjaGVkdWxlZERhdGV0aW1lLFxuICAgICAgaXNTZW50LFxuICAgICAgaXNDbG9zZWRcbiAgICB9KVxuICAgIHJldHVybiBkYi5zYXZlKHJlY29yZCkudGhlbihyZWNvcmQgPT4gbmV3IFN1cnZleShyZWNvcmQpKVxuICB9XG5cbiAgc3RhdGljIG9mIChpZCkge1xuICAgIGxldCBxdWVyeSA9IG5ldyBza3lnZWFyLlF1ZXJ5KFN1cnZleS5SZWNvcmQpXG4gICAgcXVlcnkuZXF1YWxUbygnX2lkJywgaWQpXG4gICAgcmV0dXJuIGRiLnF1ZXJ5KHF1ZXJ5KS50aGVuKHJlc3VsdCA9PiByZXN1bHRbMF0gPyBuZXcgU3VydmV5KHJlc3VsdFswXSkgOiBudWxsKVxuICB9XG5cbiAgc3RhdGljIHNjaGVkdWxlZEJ5ICh0ZWFtSUQpIHtcbiAgICBsZXQgcXVlcnkgPSBuZXcgc2t5Z2Vhci5RdWVyeShTdXJ2ZXkuUmVjb3JkKVxuICAgIHF1ZXJ5LmVxdWFsVG8oJ3RlYW1JRCcsIHRlYW1JRClcbiAgICBxdWVyeS5lcXVhbFRvKCdpc1NlbnQnLCBmYWxzZSlcbiAgICByZXR1cm4gZGIucXVlcnkocXVlcnkpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgIGlmIChyZXN1bHQubGVuZ3RoID4gMSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE11dGlwbGUgc2NoZWR1bGVkIHN1cnZleXMgZm91bmQgZm9yIHRlYW0gJHt0ZWFtSUR9YClcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXN1bHRbMF0gPyBuZXcgU3VydmV5KHJlc3VsdFswXSkgOiBudWxsXG4gICAgfSlcbiAgfVxuXG4gIHN0YXRpYyBvcGVuaW5nSW4gKHRlYW1JRCkge1xuICAgIGxldCBxdWVyeSA9IG5ldyBza3lnZWFyLlF1ZXJ5KFN1cnZleS5SZWNvcmQpXG4gICAgcXVlcnkuZXF1YWxUbygndGVhbUlEJywgdGVhbUlEKVxuICAgIHF1ZXJ5LmVxdWFsVG8oJ2lzU2VudCcsIHRydWUpXG4gICAgcXVlcnkuZXF1YWxUbygnaXNDbG9zZWQnLCBmYWxzZSlcbiAgICByZXR1cm4gZGIucXVlcnkocXVlcnkpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgIGlmIChyZXN1bHQubGVuZ3RoID4gMSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE11dGlwbGUgb3BlbmluZyBzdXJ2ZXlzIGZvdW5kIGZvciB0ZWFtICR7dGVhbUlEfWApXG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzdWx0WzBdID8gbmV3IFN1cnZleShyZXN1bHRbMF0pIDogbnVsbFxuICAgIH0pXG4gIH1cblxuICBzdGF0aWMgZ2V0IHJlYWR5VG9TZW5kICgpIHtcbiAgICBsZXQgcXVlcnkgPSBuZXcgc2t5Z2Vhci5RdWVyeShTdXJ2ZXkuUmVjb3JkKVxuICAgIHF1ZXJ5LmVxdWFsVG8oJ2lzU2VudCcsIGZhbHNlKVxuICAgIHF1ZXJ5Lmxlc3NUaGFuT3JFcXVhbFRvKCdzY2hlZHVsZWREYXRldGltZScsIG5ldyBEYXRlKCkpXG4gICAgcmV0dXJuIGRiLnF1ZXJ5KHF1ZXJ5KS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICBsZXQgcmVjb3JkcyA9IFtdXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc3VsdC5sZW5ndGg7IGkrKykge1xuICAgICAgICByZWNvcmRzLnB1c2gobmV3IFN1cnZleShyZXN1bHRbaV0pKVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlY29yZHNcbiAgICB9KVxuICB9XG5cbiAgc2V0IGlzU2VudCAobmV3VmFsdWUpIHtcbiAgICB0aGlzLl9yZWNvcmRbJ2lzU2VudCddID0gbmV3VmFsdWVcbiAgfVxuXG4gIHVwZGF0ZSAoKSB7XG4gICAgcmV0dXJuIGRiLnNhdmUodGhpcy5fcmVjb3JkKS50aGVuKHJlY29yZCA9PiBuZXcgU3VydmV5KHJlY29yZCkpXG4gIH1cblxuICBnZXQgaWQgKCkge1xuICAgIHJldHVybiB0aGlzLl9yZWNvcmRbJ2lkJ11cbiAgfVxuXG4gIGdldCB0ZWFtSUQgKCkge1xuICAgIHJldHVybiB0aGlzLl9yZWNvcmRbJ3RlYW1JRCddXG4gIH1cblxuICBnZXQgZnJlcXVlbmN5ICgpIHtcbiAgICByZXR1cm4gdGhpcy5fcmVjb3JkWydmcmVxdWVuY3knXVxuICB9XG5cbiAgZ2V0IGV4Y2x1ZGVkVXNlcnNJRCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsnZXhjbHVkZWRVc2Vyc0lEJ11cbiAgfVxuXG4gIGdldCBzY2hlZHVsZWREYXRldGltZSAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsnc2NoZWR1bGVkRGF0ZXRpbWUnXVxuICB9XG5cbiAgZ2V0IGlzU2VudCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsnaXNTZW50J11cbiAgfVxuXG4gIGdldCBpc0Nsb3NlZCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsnaXNDbG9zZWQnXVxuICB9XG5cbiAgZ2V0IHN0YXRlICgpIHtcbiAgICBpZiAoIXRoaXMuaXNTZW50ICYmICF0aGlzLmlzQ2xvc2VkKSB7XG4gICAgICByZXR1cm4gJ3NjaGVkdWxlZCdcbiAgICB9IGVsc2UgaWYgKHRoaXMuaXNTZW50ICYmICF0aGlzLmlzQ2xvc2VkKSB7XG4gICAgICByZXR1cm4gJ29wZW4nXG4gICAgfSBlbHNlIGlmICh0aGlzLmlzU2VudCAmJiAhdGhpcy5pc0Nsb3NlZCkge1xuICAgICAgcmV0dXJuICdjbG9zZWQnXG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBzdXJ2ZXkgc3RhdGUnKVxuICAgIH1cbiAgfVxuXG4gIGdldCBxMSAoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRleHQ6ICdIb3cgbGlrZWx5IGlzIGl0IHlvdSB3b3VsZCByZWNvbW1lbmQgdGhpcyBjb21wYW55IGFzIGEgcGxhY2UgdG8gd29yaz8nLFxuICAgICAgYXR0YWNobWVudHM6IFtcbiAgICAgICAge1xuICAgICAgICAgIHRleHQ6ICdDaG9vc2UgYSBzY29yZSBmcm9tIDEwIChoaWdodGVzdCkgdG8gMSAobG93ZXN0KScsXG4gICAgICAgICAgZmFsbGJhY2s6ICdZb3UgYXJlIHVuYWJsZSB0byBzZWxlY3QgYSBzY29yZScsXG4gICAgICAgICAgY2FsbGJhY2tfaWQ6ICdzYXZlU2NvcmVBbmRSZXF1ZXN0UmVhc29uJyxcbiAgICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIG5hbWU6ICdzY29yZXMnLFxuICAgICAgICAgICAgICB0eXBlOiAnc2VsZWN0JyxcbiAgICAgICAgICAgICAgb3B0aW9uczogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIHRleHQ6ICcxMCcsXG4gICAgICAgICAgICAgICAgICB2YWx1ZTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgICAgICAgICBzY29yZTogMTAsXG4gICAgICAgICAgICAgICAgICAgIHN1cnZleUlEOiB0aGlzLmlkXG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgdGV4dDogJzknLFxuICAgICAgICAgICAgICAgICAgdmFsdWU6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICAgICAgc2NvcmU6IDksXG4gICAgICAgICAgICAgICAgICAgIHN1cnZleUlEOiB0aGlzLmlkXG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgdGV4dDogJzgnLFxuICAgICAgICAgICAgICAgICAgdmFsdWU6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICAgICAgc2NvcmU6IDgsXG4gICAgICAgICAgICAgICAgICAgIHN1cnZleUlEOiB0aGlzLmlkXG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgdGV4dDogJzcnLFxuICAgICAgICAgICAgICAgICAgdmFsdWU6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICAgICAgc2NvcmU6IDcsXG4gICAgICAgICAgICAgICAgICAgIHN1cnZleUlEOiB0aGlzLmlkXG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgdGV4dDogJzYnLFxuICAgICAgICAgICAgICAgICAgdmFsdWU6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICAgICAgc2NvcmU6IDYsXG4gICAgICAgICAgICAgICAgICAgIHN1cnZleUlEOiB0aGlzLmlkXG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgdGV4dDogJzUnLFxuICAgICAgICAgICAgICAgICAgdmFsdWU6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICAgICAgc2NvcmU6IDUsXG4gICAgICAgICAgICAgICAgICAgIHN1cnZleUlEOiB0aGlzLmlkXG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgdGV4dDogJzQnLFxuICAgICAgICAgICAgICAgICAgdmFsdWU6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICAgICAgc2NvcmU6IDQsXG4gICAgICAgICAgICAgICAgICAgIHN1cnZleUlEOiB0aGlzLmlkXG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgdGV4dDogJzMnLFxuICAgICAgICAgICAgICAgICAgdmFsdWU6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICAgICAgc2NvcmU6IDMsXG4gICAgICAgICAgICAgICAgICAgIHN1cnZleUlEOiB0aGlzLmlkXG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgdGV4dDogJzInLFxuICAgICAgICAgICAgICAgICAgdmFsdWU6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICAgICAgc2NvcmU6IDIsXG4gICAgICAgICAgICAgICAgICAgIHN1cnZleUlEOiB0aGlzLmlkXG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgdGV4dDogJzEnLFxuICAgICAgICAgICAgICAgICAgdmFsdWU6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICAgICAgc2NvcmU6IDEsXG4gICAgICAgICAgICAgICAgICAgIHN1cnZleUlEOiB0aGlzLmlkXG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgfVxuICAgICAgICAgIF1cbiAgICAgICAgfVxuICAgICAgXVxuICAgIH1cbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFN1cnZleVxuIl19